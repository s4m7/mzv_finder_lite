<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Survey</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    </style>
</head>
<body class="bg-white flex justify-center items-center min-h-screen m-0">
  <form id="survey" class="w-full max-w-lg p-4">
    <!-- Questions Slides -->
    <div id="questions-container"></div>

    <!-- Submission Slide -->
    <div id="submission-slide" class="bg-gray-200 rounded-lg shadow-lg p-8 w-full text-center mb-5 hidden">
      <h2 class="text-2xl font-bold text-blue-900 mt-0">ご回答ありがとうございます。</h2>
      <p class="text-blue-900 leading-relaxed">簡易的な結果を見ますか？</p>
      <div class="mt-6 flex gap-4">
        <button type="button" id="submission-back-btn" class="flex-1 bg-gray-500 text-white border-none py-4 px-8 rounded-lg text-base cursor-pointer transition-colors hover:bg-gray-600">戻る</button>
        <button type="submit" class="flex-1 bg-blue-900 text-white border-none py-4 px-8 rounded-lg text-base cursor-pointer transition-colors hover:bg-blue-800">分析をみる</button>
      </div>
    </div>
  </form>

  <pre id="out"></pre>

  <script src="https://unpkg.com/localforage/dist/localforage.min.js"></script>
  <script>
    const questions = [
      "取締役会承認のイノベーション戦略（KPI・予算付き）はありますか？",
      "オープンイノベーションの専任チームと責任役員は明確ですか？",
      "スタートアップ探索の年次目標を管理・運用していますか？",
      "スタートアップなどとの協業時に役割・成果物・マイルストンを簡易合意書にまとめていますか？",
      "オープンイノベ／CVC向けの独立した年間予算・人員はありますか？",
      "協業のための知財の帰属／ライセンスを定めた標準契約（法務レビュー済み）はありますか？",
      "大学・コンソーシアム等とのMOU／共同研究数をモニタリングしていますか？",
      "CVC・共同開発・PoCごとにROI/KPIを定義しダッシュボードで可視化していますか？",
      "技術・財務・法務・文化面のリスクを文書で管理していますか？",
      "定期的なレビューで具体的なアクションを決定していますか？"
    ];

    const options = [
      { label: 'はい', value: 1 },
      { label: 'いいえ', value: 0 }
    ];

    const submissionSlide = document.getElementById('submission-slide');
    const questionsContainer = document.getElementById('questions-container');
    let currentQuestionIndex = 0;
    let surveyAnswers = {};
    let advanceTimeout = null;

    document.getElementById('submission-back-btn').addEventListener('click', () => {
      currentQuestionIndex--;
      showQuestion(currentQuestionIndex);
    });

    questions.forEach((question, i) => {
      const slide = document.createElement('div');
      slide.id = `question-slide-${i}`;
      slide.className = 'question-slide bg-gray-200 rounded-lg shadow-lg p-8 w-full text-center mb-5 hidden';
      slide.innerHTML = `
          <h2 class="text-2xl font-bold text-blue-900 mt-0">質問 ${i + 1}</h2>
          <p class="text-blue-900 leading-relaxed text-left">${questions[i]}</p>
          <div class="flex gap-4 mt-5">
            ${options.map(opt => `
              <label class="flex-1">
                <input type="radio" name="q${i + 1}" value="${opt.value}" class="sr-only peer">
                <div class="p-4 rounded-lg border-2 border-blue-900 text-blue-900 cursor-pointer text-center font-bold shadow-md hover:shadow-lg transition-shadow peer-checked:bg-blue-900 peer-checked:text-white peer-checked:border-blue-900">${opt.label}</div>
              </label>
            `).join('')}
          </div>
      `;
      
      slide.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('click', (e) => {
          surveyAnswers[e.target.name] = e.target.value;
          if (advanceTimeout) clearTimeout(advanceTimeout);
          advanceTimeout = setTimeout(() => {
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
          }, 300);
        });
      });

      const navContainer = document.createElement('div');
      navContainer.className = 'mt-6 flex justify-between';

      if (i > 0) {
        const backBtn = document.createElement('button');
        backBtn.type = 'button';
        backBtn.textContent = '戻る';
        backBtn.className = 'back-btn text-blue-900 bg-transparent border-none py-2 px-6 rounded-lg text-base cursor-pointer transition-colors hover:bg-blue-100';
        backBtn.addEventListener('click', () => {
          currentQuestionIndex--;
          showQuestion(currentQuestionIndex);
        });
        navContainer.appendChild(backBtn);
      } else {
        const placeholder = document.createElement('div');
        navContainer.appendChild(placeholder);
      }

      const nextBtn = document.createElement('button');
      nextBtn.type = 'button';
      nextBtn.textContent = '次へ';
      nextBtn.className = 'next-btn text-blue-900 bg-transparent border-none py-2 px-6 rounded-lg text-base cursor-pointer transition-colors hover:bg-blue-100';
      nextBtn.addEventListener('click', () => {
        if (advanceTimeout) clearTimeout(advanceTimeout);
        const currentRadios = document.querySelectorAll(`input[name="q${currentQuestionIndex + 1}"]:checked`);
        if (currentRadios.length === 0) {
          alert('回答を選択してください。');
          return;
        }
        surveyAnswers[`q${currentQuestionIndex + 1}`] = currentRadios[0].value;
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
      });
      navContainer.appendChild(nextBtn);
      
      slide.appendChild(navContainer);
      questionsContainer.appendChild(slide);
    });

    const questionSlides = questionsContainer.querySelectorAll('.question-slide');

    function showQuestion(index) {
      questionSlides.forEach((slide, i) => {
        if (i === index) {
          slide.classList.remove('hidden');
        } else {
          slide.classList.add('hidden');
        }
      });
      
      if (index >= questions.length) {
        questionsContainer.classList.add('hidden');
        submissionSlide.classList.remove('hidden');
      } else {
        questionsContainer.classList.remove('hidden');
        submissionSlide.classList.add('hidden');
      }
    }

    showQuestion(0);
    
    survey.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (Object.keys(surveyAnswers).length !== questions.length) {
        alert('すべての質問に回答してください。');
        // Optionally, send them back to the first unanswered question
        for (let i = 0; i < questions.length; i++) {
          if (!surveyAnswers[`q${i + 1}`]) {
            currentQuestionIndex = i;
            showQuestion(currentQuestionIndex);
            break;
          }
        }
        return;
      }

      const userInfo = JSON.parse(sessionStorage.getItem('userInfo'));

      if (!userInfo) {
        alert('User information is missing. Please register first.');
        window.location.href = 'register.html';
        return;
      }

      const data = { ...userInfo };
      for (const key in surveyAnswers) {
        if (key.startsWith('q')) {
          const questionIndex = parseInt(key.substring(1), 10) - 1;
          data[`Q${questionIndex + 1}`] = parseInt(surveyAnswers[key], 10);
        }
      }
      
      data.__ts = Date.now(); // helpful server-side
      
      sessionStorage.setItem('surveyResult', JSON.stringify(data));

      // Redirect to results page
      window.location.href = 'results.html';
    });
  </script>
</body>
</html>
